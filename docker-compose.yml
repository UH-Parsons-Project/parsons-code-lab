# Local development configuration for Faded Parsons Problems
# Usage: docker compose up --build
# Tests: docker compose --profile test up --build --abort-on-container-exit
# Note: Database is non-persistent - data is cleared when containers are stopped

services:
  # PostgreSQL database - local development only, production uses external database
  db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres  # Change in production!
      POSTGRES_DB: faded_parsons
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Main web application
  web:
    build:
      context: .
      dockerfile: dockerfile
    restart: always
    ports:
      - "8000:8000"
    volumes:
      - .:/usr/src/app
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db:5432/faded_parsons
    depends_on:
      db:
        condition: service_healthy

  # Web app instance for running tests against
  web-test:
    build:
      context: .
      dockerfile: dockerfile
    restart: always
    ports:
      - "8001:8000"
    volumes:
      - .:/usr/src/app
    environment:
      DATABASE_URL: postgresql+asyncpg://postgres:postgres@db:5432/faded_parsons
      TEST_MODE: "true"
    depends_on:
      db:
        condition: service_healthy
    profiles: ["test"]  # Only starts with: docker compose --profile test

  # Playwright test runner
  test:
    profiles: ["test"]
    build:
      context: .
      dockerfile: Dockerfile.test
    depends_on:
      - web-test
    environment:
      BASE_URL: http://web-test:8000
    volumes:
      - ./tests:/usr/src/app/tests
      - ./playwright.config.js:/usr/src/app/playwright.config.js
